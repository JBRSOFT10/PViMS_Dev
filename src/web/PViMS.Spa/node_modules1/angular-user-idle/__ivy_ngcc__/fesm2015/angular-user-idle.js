import { Injectable, NgZone, Optional, NgModule, defineInjectable, inject } from '@angular/core';
import { from, fromEvent, interval, merge, of, Subject, timer } from 'rxjs';
import { bufferTime, distinctUntilChanged, filter, finalize, map, scan, switchMap, take, takeUntil, tap } from 'rxjs/operators';

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as ɵngcc0 from '@angular/core';
class UserIdleConfig {
}

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/**
 * User's idle service.
 */
class UserIdleService {
    /**
     * @param {?} config
     * @param {?} _ngZone
     */
    constructor(config, _ngZone) {
        this._ngZone = _ngZone;
        this.timerStart$ = new Subject();
        this.idleDetected$ = new Subject();
        this.timeout$ = new Subject();
        /**
         * Idle value in milliseconds.
         * Default equals to 10 minutes.
         */
        this.idleMillisec = 600 * 1000;
        /**
         * Idle buffer wait time milliseconds to collect user action
         * Default equals to 1 Sec.
         */
        this.idleSensitivityMillisec = 1000;
        /**
         * Timeout value in seconds.
         * Default equals to 5 minutes.
         */
        this.timeout = 300;
        /**
         * Ping value in milliseconds.
         * Default equals to 2 minutes.
         */
        this.pingMillisec = 120 * 1000;
        if (config) {
            this.setConfig(config);
        }
    }
    /**
     * Start watching for user idle and setup timer and ping.
     * @return {?}
     */
    startWatching() {
        if (!this.activityEvents$) {
            this.activityEvents$ = merge(fromEvent(window, 'mousemove'), fromEvent(window, 'resize'), fromEvent(document, 'keydown'));
        }
        this.idle$ = from(this.activityEvents$);
        if (this.idleSubscription) {
            this.idleSubscription.unsubscribe();
        }
        // If any of user events is not active for idle-seconds when start timer.
        this.idleSubscription = this.idle$
            .pipe(bufferTime(this.idleSensitivityMillisec), // Starting point of detecting of user's inactivity
        filter(arr => !arr.length && !this.isIdleDetected && !this.isInactivityTimer), tap(() => {
            this.isIdleDetected = true;
            this.idleDetected$.next(true);
        }), switchMap(() => this._ngZone.runOutsideAngular(() => interval(1000).pipe(takeUntil(merge(this.activityEvents$, timer(this.idleMillisec).pipe(tap(() => {
            this.isInactivityTimer = true;
            this.timerStart$.next(true);
        })))), finalize(() => {
            this.isIdleDetected = false;
            this.idleDetected$.next(false);
        })))))
            .subscribe();
        this.setupTimer(this.timeout);
        this.setupPing(this.pingMillisec);
    }
    /**
     * @return {?}
     */
    stopWatching() {
        this.stopTimer();
        if (this.idleSubscription) {
            this.idleSubscription.unsubscribe();
        }
    }
    /**
     * @return {?}
     */
    stopTimer() {
        this.isInactivityTimer = false;
        this.timerStart$.next(false);
    }
    /**
     * @return {?}
     */
    resetTimer() {
        this.stopTimer();
        this.isTimeout = false;
    }
    /**
     * Return observable for timer's countdown number that emits after idle.
     * @return {?}
     */
    onTimerStart() {
        return this.timerStart$.pipe(distinctUntilChanged(), switchMap(start => (start ? this.timer$ : of(null))));
    }
    /**
     * Return observable for idle status changed
     * @return {?}
     */
    onIdleStatusChanged() {
        return this.idleDetected$.asObservable();
    }
    /**
     * Return observable for timeout is fired.
     * @return {?}
     */
    onTimeout() {
        return this.timeout$.pipe(filter(timeout => !!timeout), tap(() => (this.isTimeout = true)), map(() => true));
    }
    /**
     * @return {?}
     */
    getConfigValue() {
        return {
            idle: this.idleMillisec / 1000,
            idleSensitivity: this.idleSensitivityMillisec / 1000,
            timeout: this.timeout,
            ping: this.pingMillisec / 1000
        };
    }
    /**
     * Set config values.
     * @param {?} config
     * @return {?}
     */
    setConfigValues(config) {
        if (this.idleSubscription && !this.idleSubscription.closed) {
            console.error('Call stopWatching() before set config values');
            return;
        }
        this.setConfig(config);
    }
    /**
     * @private
     * @param {?} config
     * @return {?}
     */
    setConfig(config) {
        if (config.idle) {
            this.idleMillisec = config.idle * 1000;
        }
        if (config.ping) {
            this.pingMillisec = config.ping * 1000;
        }
        if (config.idleSensitivity) {
            this.idleSensitivityMillisec = config.idleSensitivity * 1000;
        }
        if (config.timeout) {
            this.timeout = config.timeout;
        }
    }
    /**
     * Set custom activity events
     *
     * @param {?} customEvents Example: merge(
     *   fromEvent(window, 'mousemove'),
     *   fromEvent(window, 'resize'),
     *   fromEvent(document, 'keydown'),
     *   fromEvent(document, 'touchstart'),
     *   fromEvent(document, 'touchend')
     * )
     * @return {?}
     */
    setCustomActivityEvents(customEvents) {
        if (this.idleSubscription && !this.idleSubscription.closed) {
            console.error('Call stopWatching() before set custom activity events');
            return;
        }
        this.activityEvents$ = customEvents;
    }
    /**
     * Setup timer.
     *
     * Counts every seconds and return n+1 and fire timeout for last count.
     * @protected
     * @param {?} timeout Timeout in seconds.
     * @return {?}
     */
    setupTimer(timeout) {
        this._ngZone.runOutsideAngular(() => {
            this.timer$ = interval(1000).pipe(take(timeout), map(() => 1), scan((acc, n) => acc + n), tap(count => {
                if (count === timeout) {
                    this.timeout$.next(true);
                }
            }));
        });
    }
    /**
     * Setup ping.
     *
     * Pings every ping-seconds only if is not timeout.
     * @protected
     * @param {?} pingMillisec
     * @return {?}
     */
    setupPing(pingMillisec) {
        this.ping$ = interval(pingMillisec).pipe(filter(() => !this.isTimeout));
    }
}
UserIdleService.ɵfac = function UserIdleService_Factory(t) { return new (t || UserIdleService)(ɵngcc0.ɵɵinject(UserIdleConfig, 8), ɵngcc0.ɵɵinject(ɵngcc0.NgZone)); };
UserIdleService.ɵprov = ɵngcc0.ɵɵdefineInjectable({ token: UserIdleService, factory: UserIdleService.ɵfac, providedIn: 'root' });
/** @nocollapse */
UserIdleService.ctorParameters = () => [
    { type: UserIdleConfig, decorators: [{ type: Optional }] },
    { type: NgZone }
];
/** @nocollapse */ UserIdleService.ngInjectableDef = defineInjectable({ factory: function UserIdleService_Factory() { return new UserIdleService(inject(UserIdleConfig, 8), inject(NgZone)); }, token: UserIdleService, providedIn: "root" });
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(UserIdleService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: UserIdleConfig, decorators: [{
                type: Optional
            }] }, { type: ɵngcc0.NgZone }]; }, null); })();

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
class UserIdleModule {
    /**
     * @param {?} config
     * @return {?}
     */
    static forRoot(config) {
        return {
            ngModule: UserIdleModule,
            providers: [
                { provide: UserIdleConfig, useValue: config }
            ]
        };
    }
}
UserIdleModule.ɵfac = function UserIdleModule_Factory(t) { return new (t || UserIdleModule)(); };
UserIdleModule.ɵmod = ɵngcc0.ɵɵdefineNgModule({ type: UserIdleModule });
UserIdleModule.ɵinj = ɵngcc0.ɵɵdefineInjector({ imports: [[]] });
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(UserIdleModule, [{
        type: NgModule,
        args: [{
                imports: []
            }]
    }], null, null); })();

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */

export { UserIdleService, UserIdleConfig, UserIdleModule };

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5ndWxhci11c2VyLWlkbGUuanMiLCJzb3VyY2VzIjpbImFuZ3VsYXItdXNlci1pZGxlL2xpYi9hbmd1bGFyLXVzZXItaWRsZS5jb25maWcudHMiLCJhbmd1bGFyLXVzZXItaWRsZS9saWIvYW5ndWxhci11c2VyLWlkbGUuc2VydmljZS50cyIsImFuZ3VsYXItdXNlci1pZGxlL2xpYi9hbmd1bGFyLXVzZXItaWRsZS5tb2R1bGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUEsTUFBYSxjQUFjO0FBQzNCLENBaUJDO0FBQ0Q7QUFBQztBQUFJO0FBQWtDO0FBQXFHO0FDbkI1STtBQUFJO0FBQXdCO0FBZ0M1QixNQUFhLGVBQWU7QUFDNUI7QUFBUTtBQUdSO0FBQTBCO0FBQVEsSUF5Q2hDLFlBQXdCLE1BQXNCLEVBQVUsT0FBZTtBQUN6RSxRQUQwRCxZQUFPLEdBQVAsT0FBTyxDQUFRO0FBQUMsUUFyQzlELGdCQUFXLEdBQUcsSUFBSSxPQUFPLEVBQVcsQ0FBQztBQUNqRCxRQUFZLGtCQUFhLEdBQUcsSUFBSSxPQUFPLEVBQVcsQ0FBQztBQUNuRCxRQUFZLGFBQVEsR0FBRyxJQUFJLE9BQU8sRUFBVyxDQUFDO0FBQzlDO0FBQVk7QUFDRztBQUVGO0FBQVksUUFHYixpQkFBWSxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUM7QUFDdEM7QUFDTTtBQUNNO0FBRUE7QUFBWSxRQUFaLDRCQUF1QixHQUFHLElBQUksQ0FBQztBQUMzQztBQUNNO0FBQ007QUFFQTtBQUFZLFFBQVosWUFBTyxHQUFHLEdBQUcsQ0FBQztBQUMxQjtBQUNNO0FBQ007QUFFQTtBQUFZLFFBQVosaUJBQVksR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDO0FBQ3RDLFFBYUksSUFBSSxNQUFNLEVBQUU7QUFDaEIsWUFBTSxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQzdCLFNBQUs7QUFDTCxLQUFHO0FBQ0g7QUFFQztBQUNFO0FBQ2E7QUFDWixJQURGLGFB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QUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFHQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUNBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFDQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUNBLEFBQ0EsQUFDQSxBQUNBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQ0EsQUFDQSxBQUNBLEFBQ0EsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUVBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUVBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFDQSxBQUVBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFFQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUtBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQ0EsQUFLQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFLQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUNBLEFBRUEsQUFBQSxBQUNBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQ0EsQUFNQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFDQSxBQUVBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUVBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFDQSxBQWFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUNBLEFBRUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQVFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUNBLEFBQUEsQUFDQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQ0EsQUFRQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFsUEEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQVBBLEFBQUEsQUFxREEsQUFBQSxBQTdFQSxBQUFBLEFDQUEsQUFNQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFDQSxBQUFBLEFBQ0EsQUFYQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUNBIiwic291cmNlc0NvbnRlbnQiOlsiZXhwb3J0IGNsYXNzIFVzZXJJZGxlQ29uZmlnIHtcbiAgLyoqXG4gICAqIElkbGUgdmFsdWUgaW4gc2Vjb25kcy5cbiAgICovXG4gIGlkbGU/OiBudW1iZXI7XG4gIC8qKlxuICAgKiBUaW1lb3V0IHZhbHVlIGluIHNlY29uZHMuXG4gICAqL1xuICB0aW1lb3V0PzogbnVtYmVyO1xuICAvKipcbiAgICogUGluZyB2YWx1ZSBpbiBzZWNvbmRzLlxuICAgKi9cbiAgcGluZz86IG51bWJlcjtcbiAgLyoqXG4gICAqIElkbGVTZW5zaXRpdml0eSB0aW1lIHRoYXQgYWN0aXZpdHkgbXVzdCByZW1haW4gYmVsb3cgdGhlIGlkbGUgZGV0ZWN0aW9uIHRocmVzaG9sZCBiZWZvcmVcbiAgICogaWRsZSBidWZmZXIgdGltZXIgY291bnQgdXNlcidzIGFjdGl2aXR5IGFjdGlvbnMsIGluIHNlY29uZHMuXG4gICAqL1xuICBpZGxlU2Vuc2l0aXZpdHk/OiBudW1iZXI7XG59XG4iLCJpbXBvcnQgeyBJbmplY3RhYmxlLCBOZ1pvbmUsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICBmcm9tLFxuICBmcm9tRXZlbnQsXG4gIGludGVydmFsLFxuICBtZXJnZSxcbiAgT2JzZXJ2YWJsZSxcbiAgb2YsXG4gIFN1YmplY3QsXG4gIFN1YnNjcmlwdGlvbixcbiAgdGltZXJcbn0gZnJvbSAncnhqcyc7XG5pbXBvcnQge1xuICBidWZmZXJUaW1lLFxuICBkaXN0aW5jdFVudGlsQ2hhbmdlZCxcbiAgZmlsdGVyLFxuICBmaW5hbGl6ZSxcbiAgbWFwLFxuICBzY2FuLFxuICBzd2l0Y2hNYXAsXG4gIHRha2UsXG4gIHRha2VVbnRpbCxcbiAgdGFwXG59IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFVzZXJJZGxlQ29uZmlnIH0gZnJvbSAnLi9hbmd1bGFyLXVzZXItaWRsZS5jb25maWcnO1xuXG4vKipcbiAqIFVzZXIncyBpZGxlIHNlcnZpY2UuXG4gKi9cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIFVzZXJJZGxlU2VydmljZSB7XG4gIHBpbmckOiBPYnNlcnZhYmxlPGFueT47XG5cbiAgLyoqXG4gICAqIEV2ZW50cyB0aGF0IGNhbiBpbnRlcnJ1cHRzIHVzZXIncyBpbmFjdGl2aXR5IHRpbWVyLlxuICAgKi9cbiAgcHJvdGVjdGVkIGFjdGl2aXR5RXZlbnRzJDogT2JzZXJ2YWJsZTxhbnk+O1xuXG4gIHByb3RlY3RlZCB0aW1lclN0YXJ0JCA9IG5ldyBTdWJqZWN0PGJvb2xlYW4+KCk7XG4gIHByb3RlY3RlZCBpZGxlRGV0ZWN0ZWQkID0gbmV3IFN1YmplY3Q8Ym9vbGVhbj4oKTtcbiAgcHJvdGVjdGVkIHRpbWVvdXQkID0gbmV3IFN1YmplY3Q8Ym9vbGVhbj4oKTtcbiAgcHJvdGVjdGVkIGlkbGUkOiBPYnNlcnZhYmxlPGFueT47XG4gIHByb3RlY3RlZCB0aW1lciQ6IE9ic2VydmFibGU8YW55PjtcbiAgLyoqXG4gICAqIElkbGUgdmFsdWUgaW4gbWlsbGlzZWNvbmRzLlxuICAgKiBEZWZhdWx0IGVxdWFscyB0byAxMCBtaW51dGVzLlxuICAgKi9cbiAgcHJvdGVjdGVkIGlkbGVNaWxsaXNlYyA9IDYwMCAqIDEwMDA7XG4gIC8qKlxuICAgKiBJZGxlIGJ1ZmZlciB3YWl0IHRpbWUgbWlsbGlzZWNvbmRzIHRvIGNvbGxlY3QgdXNlciBhY3Rpb25cbiAgICogRGVmYXVsdCBlcXVhbHMgdG8gMSBTZWMuXG4gICAqL1xuICBwcm90ZWN0ZWQgaWRsZVNlbnNpdGl2aXR5TWlsbGlzZWMgPSAxMDAwO1xuICAvKipcbiAgICogVGltZW91dCB2YWx1ZSBpbiBzZWNvbmRzLlxuICAgKiBEZWZhdWx0IGVxdWFscyB0byA1IG1pbnV0ZXMuXG4gICAqL1xuICBwcm90ZWN0ZWQgdGltZW91dCA9IDMwMDtcbiAgLyoqXG4gICAqIFBpbmcgdmFsdWUgaW4gbWlsbGlzZWNvbmRzLlxuICAgKiBEZWZhdWx0IGVxdWFscyB0byAyIG1pbnV0ZXMuXG4gICAqL1xuICBwcm90ZWN0ZWQgcGluZ01pbGxpc2VjID0gMTIwICogMTAwMDtcbiAgLyoqXG4gICAqIFRpbWVvdXQgc3RhdHVzLlxuICAgKi9cbiAgcHJvdGVjdGVkIGlzVGltZW91dDogYm9vbGVhbjtcbiAgLyoqXG4gICAqIFRpbWVyIG9mIHVzZXIncyBpbmFjdGl2aXR5IGlzIGluIHByb2dyZXNzLlxuICAgKi9cbiAgcHJvdGVjdGVkIGlzSW5hY3Rpdml0eVRpbWVyOiBib29sZWFuO1xuICBwcm90ZWN0ZWQgaXNJZGxlRGV0ZWN0ZWQ6IGJvb2xlYW47XG5cbiAgcHJvdGVjdGVkIGlkbGVTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcblxuICBjb25zdHJ1Y3RvcihAT3B0aW9uYWwoKSBjb25maWc6IFVzZXJJZGxlQ29uZmlnLCBwcml2YXRlIF9uZ1pvbmU6IE5nWm9uZSkge1xuICAgIGlmIChjb25maWcpIHtcbiAgICAgIHRoaXMuc2V0Q29uZmlnKGNvbmZpZyk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFN0YXJ0IHdhdGNoaW5nIGZvciB1c2VyIGlkbGUgYW5kIHNldHVwIHRpbWVyIGFuZCBwaW5nLlxuICAgKi9cbiAgc3RhcnRXYXRjaGluZygpIHtcbiAgICBpZiAoIXRoaXMuYWN0aXZpdHlFdmVudHMkKSB7XG4gICAgICB0aGlzLmFjdGl2aXR5RXZlbnRzJCA9IG1lcmdlKFxuICAgICAgICBmcm9tRXZlbnQod2luZG93LCAnbW91c2Vtb3ZlJyksXG4gICAgICAgIGZyb21FdmVudCh3aW5kb3csICdyZXNpemUnKSxcbiAgICAgICAgZnJvbUV2ZW50KGRvY3VtZW50LCAna2V5ZG93bicpXG4gICAgICApO1xuICAgIH1cblxuICAgIHRoaXMuaWRsZSQgPSBmcm9tKHRoaXMuYWN0aXZpdHlFdmVudHMkKTtcblxuICAgIGlmICh0aGlzLmlkbGVTdWJzY3JpcHRpb24pIHtcbiAgICAgIHRoaXMuaWRsZVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIH1cblxuICAgIC8vIElmIGFueSBvZiB1c2VyIGV2ZW50cyBpcyBub3QgYWN0aXZlIGZvciBpZGxlLXNlY29uZHMgd2hlbiBzdGFydCB0aW1lci5cbiAgICB0aGlzLmlkbGVTdWJzY3JpcHRpb24gPSB0aGlzLmlkbGUkXG4gICAgICAucGlwZShcbiAgICAgICAgYnVmZmVyVGltZSh0aGlzLmlkbGVTZW5zaXRpdml0eU1pbGxpc2VjKSwgLy8gU3RhcnRpbmcgcG9pbnQgb2YgZGV0ZWN0aW5nIG9mIHVzZXIncyBpbmFjdGl2aXR5XG4gICAgICAgIGZpbHRlcihcbiAgICAgICAgICBhcnIgPT4gIWFyci5sZW5ndGggJiYgIXRoaXMuaXNJZGxlRGV0ZWN0ZWQgJiYgIXRoaXMuaXNJbmFjdGl2aXR5VGltZXJcbiAgICAgICAgKSxcbiAgICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgICB0aGlzLmlzSWRsZURldGVjdGVkID0gdHJ1ZTtcbiAgICAgICAgICB0aGlzLmlkbGVEZXRlY3RlZCQubmV4dCh0cnVlKTtcbiAgICAgICAgfSksXG4gICAgICAgIHN3aXRjaE1hcCgoKSA9PlxuICAgICAgICAgIHRoaXMuX25nWm9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PlxuICAgICAgICAgICAgaW50ZXJ2YWwoMTAwMCkucGlwZShcbiAgICAgICAgICAgICAgdGFrZVVudGlsKFxuICAgICAgICAgICAgICAgIG1lcmdlKFxuICAgICAgICAgICAgICAgICAgdGhpcy5hY3Rpdml0eUV2ZW50cyQsXG4gICAgICAgICAgICAgICAgICB0aW1lcih0aGlzLmlkbGVNaWxsaXNlYykucGlwZShcbiAgICAgICAgICAgICAgICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICB0aGlzLmlzSW5hY3Rpdml0eVRpbWVyID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRpbWVyU3RhcnQkLm5leHQodHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICBmaW5hbGl6ZSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5pc0lkbGVEZXRlY3RlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHRoaXMuaWRsZURldGVjdGVkJC5uZXh0KGZhbHNlKTtcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIClcbiAgICAgICAgICApXG4gICAgICAgIClcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUoKTtcblxuICAgIHRoaXMuc2V0dXBUaW1lcih0aGlzLnRpbWVvdXQpO1xuICAgIHRoaXMuc2V0dXBQaW5nKHRoaXMucGluZ01pbGxpc2VjKTtcbiAgfVxuXG4gIHN0b3BXYXRjaGluZygpIHtcbiAgICB0aGlzLnN0b3BUaW1lcigpO1xuICAgIGlmICh0aGlzLmlkbGVTdWJzY3JpcHRpb24pIHtcbiAgICAgIHRoaXMuaWRsZVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIH1cbiAgfVxuXG4gIHN0b3BUaW1lcigpIHtcbiAgICB0aGlzLmlzSW5hY3Rpdml0eVRpbWVyID0gZmFsc2U7XG4gICAgdGhpcy50aW1lclN0YXJ0JC5uZXh0KGZhbHNlKTtcbiAgfVxuXG4gIHJlc2V0VGltZXIoKSB7XG4gICAgdGhpcy5zdG9wVGltZXIoKTtcbiAgICB0aGlzLmlzVGltZW91dCA9IGZhbHNlO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybiBvYnNlcnZhYmxlIGZvciB0aW1lcidzIGNvdW50ZG93biBudW1iZXIgdGhhdCBlbWl0cyBhZnRlciBpZGxlLlxuICAgKi9cbiAgb25UaW1lclN0YXJ0KCk6IE9ic2VydmFibGU8bnVtYmVyPiB7XG4gICAgcmV0dXJuIHRoaXMudGltZXJTdGFydCQucGlwZShcbiAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKCksXG4gICAgICBzd2l0Y2hNYXAoc3RhcnQgPT4gKHN0YXJ0ID8gdGhpcy50aW1lciQgOiBvZihudWxsKSkpXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm4gb2JzZXJ2YWJsZSBmb3IgaWRsZSBzdGF0dXMgY2hhbmdlZFxuICAgKi9cbiAgb25JZGxlU3RhdHVzQ2hhbmdlZCgpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gdGhpcy5pZGxlRGV0ZWN0ZWQkLmFzT2JzZXJ2YWJsZSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybiBvYnNlcnZhYmxlIGZvciB0aW1lb3V0IGlzIGZpcmVkLlxuICAgKi9cbiAgb25UaW1lb3V0KCk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgIHJldHVybiB0aGlzLnRpbWVvdXQkLnBpcGUoXG4gICAgICBmaWx0ZXIodGltZW91dCA9PiAhIXRpbWVvdXQpLFxuICAgICAgdGFwKCgpID0+ICh0aGlzLmlzVGltZW91dCA9IHRydWUpKSxcbiAgICAgIG1hcCgoKSA9PiB0cnVlKVxuICAgICk7XG4gIH1cblxuICBnZXRDb25maWdWYWx1ZSgpOiBVc2VySWRsZUNvbmZpZyB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGlkbGU6IHRoaXMuaWRsZU1pbGxpc2VjIC8gMTAwMCxcbiAgICAgIGlkbGVTZW5zaXRpdml0eTogdGhpcy5pZGxlU2Vuc2l0aXZpdHlNaWxsaXNlYyAvIDEwMDAsXG4gICAgICB0aW1lb3V0OiB0aGlzLnRpbWVvdXQsXG4gICAgICBwaW5nOiB0aGlzLnBpbmdNaWxsaXNlYyAvIDEwMDBcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCBjb25maWcgdmFsdWVzLlxuICAgKiBAcGFyYW0gY29uZmlnXG4gICAqL1xuICBzZXRDb25maWdWYWx1ZXMoY29uZmlnOiBVc2VySWRsZUNvbmZpZykge1xuICAgIGlmICh0aGlzLmlkbGVTdWJzY3JpcHRpb24gJiYgIXRoaXMuaWRsZVN1YnNjcmlwdGlvbi5jbG9zZWQpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0NhbGwgc3RvcFdhdGNoaW5nKCkgYmVmb3JlIHNldCBjb25maWcgdmFsdWVzJyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5zZXRDb25maWcoY29uZmlnKTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0Q29uZmlnKGNvbmZpZzogVXNlcklkbGVDb25maWcpIHtcbiAgICBpZiAoY29uZmlnLmlkbGUpIHtcbiAgICAgIHRoaXMuaWRsZU1pbGxpc2VjID0gY29uZmlnLmlkbGUgKiAxMDAwO1xuICAgIH1cbiAgICBpZiAoY29uZmlnLnBpbmcpIHtcbiAgICAgIHRoaXMucGluZ01pbGxpc2VjID0gY29uZmlnLnBpbmcgKiAxMDAwO1xuICAgIH1cbiAgICBpZiAoY29uZmlnLmlkbGVTZW5zaXRpdml0eSkge1xuICAgICAgdGhpcy5pZGxlU2Vuc2l0aXZpdHlNaWxsaXNlYyA9IGNvbmZpZy5pZGxlU2Vuc2l0aXZpdHkgKiAxMDAwO1xuICAgIH1cbiAgICBpZiAoY29uZmlnLnRpbWVvdXQpIHtcbiAgICAgIHRoaXMudGltZW91dCA9IGNvbmZpZy50aW1lb3V0O1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgY3VzdG9tIGFjdGl2aXR5IGV2ZW50c1xuICAgKlxuICAgKiBAcGFyYW0gY3VzdG9tRXZlbnRzIEV4YW1wbGU6IG1lcmdlKFxuICAgKiAgIGZyb21FdmVudCh3aW5kb3csICdtb3VzZW1vdmUnKSxcbiAgICogICBmcm9tRXZlbnQod2luZG93LCAncmVzaXplJyksXG4gICAqICAgZnJvbUV2ZW50KGRvY3VtZW50LCAna2V5ZG93bicpLFxuICAgKiAgIGZyb21FdmVudChkb2N1bWVudCwgJ3RvdWNoc3RhcnQnKSxcbiAgICogICBmcm9tRXZlbnQoZG9jdW1lbnQsICd0b3VjaGVuZCcpXG4gICAqIClcbiAgICovXG4gIHNldEN1c3RvbUFjdGl2aXR5RXZlbnRzKGN1c3RvbUV2ZW50czogT2JzZXJ2YWJsZTxhbnk+KSB7XG4gICAgaWYgKHRoaXMuaWRsZVN1YnNjcmlwdGlvbiAmJiAhdGhpcy5pZGxlU3Vic2NyaXB0aW9uLmNsb3NlZCkge1xuICAgICAgY29uc29sZS5lcnJvcignQ2FsbCBzdG9wV2F0Y2hpbmcoKSBiZWZvcmUgc2V0IGN1c3RvbSBhY3Rpdml0eSBldmVudHMnKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLmFjdGl2aXR5RXZlbnRzJCA9IGN1c3RvbUV2ZW50cztcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXR1cCB0aW1lci5cbiAgICpcbiAgICogQ291bnRzIGV2ZXJ5IHNlY29uZHMgYW5kIHJldHVybiBuKzEgYW5kIGZpcmUgdGltZW91dCBmb3IgbGFzdCBjb3VudC5cbiAgICogQHBhcmFtIHRpbWVvdXQgVGltZW91dCBpbiBzZWNvbmRzLlxuICAgKi9cbiAgcHJvdGVjdGVkIHNldHVwVGltZXIodGltZW91dDogbnVtYmVyKSB7XG4gICAgdGhpcy5fbmdab25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcbiAgICAgIHRoaXMudGltZXIkID0gaW50ZXJ2YWwoMTAwMCkucGlwZShcbiAgICAgICAgdGFrZSh0aW1lb3V0KSxcbiAgICAgICAgbWFwKCgpID0+IDEpLFxuICAgICAgICBzY2FuKChhY2MsIG4pID0+IGFjYyArIG4pLFxuICAgICAgICB0YXAoY291bnQgPT4ge1xuICAgICAgICAgIGlmIChjb3VudCA9PT0gdGltZW91dCkge1xuICAgICAgICAgICAgdGhpcy50aW1lb3V0JC5uZXh0KHRydWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogU2V0dXAgcGluZy5cbiAgICpcbiAgICogUGluZ3MgZXZlcnkgcGluZy1zZWNvbmRzIG9ubHkgaWYgaXMgbm90IHRpbWVvdXQuXG4gICAqIEBwYXJhbSBwaW5nTWlsbGlzZWNcbiAgICovXG4gIHByb3RlY3RlZCBzZXR1cFBpbmcocGluZ01pbGxpc2VjOiBudW1iZXIpIHtcbiAgICB0aGlzLnBpbmckID0gaW50ZXJ2YWwocGluZ01pbGxpc2VjKS5waXBlKGZpbHRlcigoKSA9PiAhdGhpcy5pc1RpbWVvdXQpKTtcbiAgfVxufVxuIiwiaW1wb3J0IHsgTW9kdWxlV2l0aFByb3ZpZGVycywgTmdNb2R1bGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFVzZXJJZGxlQ29uZmlnIH0gZnJvbSAnLi9hbmd1bGFyLXVzZXItaWRsZS5jb25maWcnO1xuXG5ATmdNb2R1bGUoe1xuICBpbXBvcnRzOiBbXVxufSlcbmV4cG9ydCBjbGFzcyBVc2VySWRsZU1vZHVsZSB7XG4gIHN0YXRpYyBmb3JSb290KGNvbmZpZzogVXNlcklkbGVDb25maWcpOiBNb2R1bGVXaXRoUHJvdmlkZXJzPFVzZXJJZGxlTW9kdWxlPiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG5nTW9kdWxlOiBVc2VySWRsZU1vZHVsZSxcbiAgICAgIHByb3ZpZGVyczogW1xuICAgICAgICB7cHJvdmlkZTogVXNlcklkbGVDb25maWcsIHVzZVZhbHVlOiBjb25maWd9XG4gICAgICBdXG4gICAgfTtcbiAgfVxufVxuIl19